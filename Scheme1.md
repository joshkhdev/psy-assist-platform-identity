
# Диаграмма последовательности для схемы, когда Микросервис Аутентификации работает отдельно от Основного проекта

## Регистрация пользователя:

 * Пользователь отправляет данные регистрации на ОП.
 * ОП сохраняет данные пользователя в базе данных и отправляет подтверждение регистрации пользователю.

## Логин пользователя:

 * Пользователь отправляет учётные данные на ОП.
 * ОП проверяет учётные данные в базе данных.
* Если данные верны, ОП запрашивает у МА создание JWT.
* МА создаёт JWT и отправляет его обратно в ОП.
* ОП отправляет JWT пользователю.

## Использование JWT:

* Пользователь отправляет запрос на защищённый ресурс с JWT.
*ОП проверяет JWT с помощью публичного ключа МА.

## Обновление токенов:

* Если JWT истекает, ОП запрашивает у МА новый токен.
* МА выдаёт новый токен и отправляет его ОП, который передаёт его пользователю.

## Отзыв токенов:

 * Если пользователь выходит из системы или его сессия аннулируется, ОП сообщает МА об отзыве токена.
 * МА добавляет токен в список отзыва.


# Схема

```mermaid
sequenceDiagram
    participant User as Пользователь
    participant OP as Основной проект
    participant MA as Микросервис аутентификации

    %% Регистрация пользователя
    rect rgb(235, 248, 255) 
    User->>+OP: Отправляет данные регистрации
    OP -->>-User: Подтверждение регистрации
    end

    %% Логин пользователя
    rect rgb(250, 235, 215)
    User->>+OP: Отправляет учётные данные
    alt учётные данные корректны
        OP->>+MA: Запрос на создание JWT
        MA-->>-OP: JWT создан и отправлен
        OP-->>User: JWT отправлен пользователю
    else учётные данные некорректны
        OP-->>-User: Ошибка аутентификации
    end
    end

    %% Использование JWT
    rect rgb(255, 239, 235)  
    User->>+OP: Запрос с JWT на защищённый ресурс
    OP->>+MA: Проверка JWT
    MA-->>-OP: JWT действителен
    OP-->>-User: Доступ к ресурсу предоставлен
end

    %% Обновление токенов
    rect rgb(234, 232, 242) 
    User->>+OP: Запрос на обновление JWT
    OP->>+MA: Запрос на новый JWT
    MA-->>-OP: Новый JWT создан и отправлен
    OP-->>-User: Новый JWT отправлен пользователю
    end

    %% Отзыв токенов
    rect rgb(233, 245, 233) 
    User->>+OP: Запрос на отзыв JWT
    OP->>+MA: Уведомление об отзыве JWT
    MA-->>-MA: Добавление JWT в список отзыва
end

```
